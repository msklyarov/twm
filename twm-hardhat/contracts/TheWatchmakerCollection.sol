/////////////////////////////////////////////////////////////
// KYL // THE WATCHMAKER // ERC721 NFT COLLECTION // 2022 //
/////////////////////////////////////////////////////////////
// producer: KYL WATCHES LTD // Instagram: @kylwatchesltd //
///////////////////////////////////////////////////////////
// dev3: Valentino Kenpachi //   Telegram: @valeken   //
///////////////////////////////////////////////////////
// designer: Rino Russo // Instagram: @rino_russo_  //
/////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////
//    ___  _______  __  _______   _______  ___  __   __  _______          ///
//   |   ||       ||  ||       | |       ||   ||  |_|  ||       |        ///
//   |   ||_     _||__||  _____| |_     _||   ||       ||    ___|       ///
//   |   |  |   |      | |_____    |   |  |   ||       ||   |___       ///
//   |   |  |   |      |_____  |   |   |  |   ||       ||    ___|     ///
//   |   |  |   |       _____| |   |   |  |   || ||_|| ||   |___     ///
//   |___|  |___|      |_______|   |___|  |___||_|   |_||_______|   ///
//                                                                 ///
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                  ///
//                                                                                 ./%@@@@@@@#,                    ///
//                                           .*(%&@@@@&&%%%##%%%&&@@@@%#*.    ,#@@&#/*,,.....,#@&,                ///
//                                     *%&@@&(*,.......................,*#@@@@#*******,%@@@@@@@@@@(              ///
//                                ,&@@&*.................................... (@@#,******,,,*/#@@@#              ///
//                            ,%@@#,............................................%@%*****/(//*,,..&&.           ///
//                         ,&@%*.,,,.............................................,%@#****//((#&@@@%.          ///
//                       (@&*,,,,,,,,..............................................,@&******,.../@&.         ///
//                     /@@,,,,,,,,,,,,...............................................%@(,/%#/,,..,%@,       ///
//      .*%@@@@&&&&%%%@@/,,,,,,,,,,,,,,,..............................................#@#,**#@@/,.*@@.     ///
//    (@@(,.........,&@*.,,,,,,,,,,,,,,,,............................(@(.............. (@(,**,&@,.,%@*    ///
//  .&@/..,/%&(.....#@/.,,,,,,,,,,,,,,,,,,.....................,(%@&/,..................#@(,**(@&.,%@*   ///
//  #@#&@@@@%,......&&,,,,,,,,,,,,,,,,,,,,,,.......... .*#@@@&(. ...............  .......&@/**(@@&*&@.  ///
// .#&(#@&,.../&#*,*@#.,,,,,,,,,,,,,,,,,,,,,,,*/#&@@&%(*..................,/%@@@@@(*.....,@&*,#@*/@&,  ///
//    %@*.,(@@#*,,.*@#.,,,,,,,,,.%&&&@@@&%%#/*,,......................*&@&#*...,@&#@&,..../@#*@%      ///
//    (@&@@%*******/@#.,,,,,,,,,,,,,,,,,,,,,,,,,....................#@&*.#@@@&/..,&@*......%@@&.      ///
//       @&****,(@@*&&.,,,,,,,,,,,,,,,,,,,,,,,,,,..................%@*.,&@@@@@@@@@@@@%* ...(@/        ///
//      .@&****@@/,.#@*.,,,,,,,,,,,,,,,,,,,,,,,,,,..............*@@%*(@@@@@@@@&&&&&@@@@@@&*,&@,       ///
//       %@/**/@@*,./@%.,,,,/%&@@@@&%%%&&@@&/,,.,,..............&&(@@@@@%@@####%##(((((%@@@@@@%.      ///
//        &@**,#@#,.,%@*.,,*%@@%************#@@@@#,............,&@@@@#(#&@@@&%###%@@@@#(((&@@@@(      ///
//        .%@#,/@@%,*(@%,,,%@@/,**,,/%@@@@@@@@@&#&@#.......... #@@@#(%@@%*/%@@@@@@&(/#@@%((#@@@@.     ///
//          ,@&/@&&@#*%@(,,,./@&&@@@@@@@&&@&&&@@@@@@@(......../@@@((&@&/%@@@@@@@*     *%@&(((@@@&     ///
//            .((. .%@&@@*,,,#@@@@#/%*,,,*@(.,,,#/*%@@@&,.....%@@%(%@@/&@@@@@@@@(.  ,%&/&@%((&@@@*    ///
//                    .(@@*/@@@&,,,,,&#.,,(*..*@/.,,,*@@@#....(@@&(%@&/@@@@@@@@@@@@@@@@/&@#((@@@@%    ///
//                      *@@@@@#%@%,.,,,,,,,,,,,,.. /@@/@@@%%@@@@@@%(&@%%@@@@@@@@@@@@@@/&@&((&@@@@&    ///
//                       #@@@(.,,.,,,,.,,,*(%&%/, .    ,@@@&#/,.#@@&(&@@#&@@@@@@@@@@#%@@#((@@@&/@&    ///
//                       %@@&.***,*##(*.&@@@@&,    ,,,,,@@@,.....*@@@&(#@@@&&&%%&&@@@&((#@@@@/.(@(    ///
//                       &@@@.          #@/*. ..       *@@&........,%@@@&#(((####(((#&@@@@&*..,&@.    ///
//                       (@@@*    (,   @%         #,   %@@(............%@@@@@@@@@@@@@@@#......(@/     ///
//                        #@@@((#,    (,            (&@@@#,...........*#&@%,,*//**............@%      ///
//                         *@@@@(   ,&*  .&*   %(  .#@@@&%*...............#@/./#&@@@&&@@@&%/,%@*      ///
//                           .&@@@@&%,   .@/   .#@@@@@#@@,,,.............,%@@%/,...%@%/...,*(%@@@&#*  ///
//                             /@@@@@@@@@@@@@@@@@@&*.,#@*.,,............(@%.,,&@/...../&@@@(.,#@@@(   ///
//                               /@&*..,*****,..,*(#%&&@@@&(*.........(@@*.....*&@#...,#@@(&@%,       ///
//                                 /@@/.,,,,*%@@%(/,...,,.,*#&@@@@@@@&(,.........*&@&&&/../@(         ///
//                                   ,&@%,(@@(,#@#,*,&@/*,**,................,(&@@(......,@&.         ///
//                                      %@@*,(@&/**,#@#*****,..,,,.*,.....#@@&* .........&@*         ////
//                                   .%@%**/@@%//**#@@%(*********//((#&@@%*..*,.........#@(         /////
//                                .@@@@@@@@&%@@#(#(,.,/%%%%###((/**,.....,(@%,....... (@/          //////
//                                             *@@(,,,,,,,,,,,,,(@&&&&@@@#/...........%@/         ///////
//                                                %@@,.,,,,,,,,,,,,,,,,,........... /@@.         ////////
//                                                  *&@%,,,,,,,,,,,,,,.........,/&@@#.          /////////
//                                                     ,%@&(,........,,*/#%@@@%(,              //////////
//                                                         *%@@@@@@@&%(*,.                    ///////////
//                                                                                           ////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                       ////////
//  ████████╗██╗  ██╗███████╗    ██╗    ██╗ █████╗ ████████╗ ██████╗██╗  ██╗███╗   ███╗ █████╗ ██╗  ██╗███████╗██████╗       ///
//  ╚══██╔══╝██║  ██║██╔════╝    ██║    ██║██╔══██╗╚══██╔══╝██╔════╝██║  ██║████╗ ████║██╔══██╗██║ ██╔╝██╔════╝██╔══██╗     ///
//     ██║   ███████║█████╗      ██║ █╗ ██║███████║   ██║   ██║     ███████║██╔████╔██║███████║█████╔╝ █████╗  ██████╔╝    ///
//     ██║   ██╔══██║██╔══╝      ██║███╗██║██╔══██║   ██║   ██║     ██╔══██║██║╚██╔╝██║██╔══██║██╔═██╗ ██╔══╝  ██╔══██╗   ///
//     ██║   ██║  ██║███████╗    ╚███╔███╔╝██║  ██║   ██║   ╚██████╗██║  ██║██║ ╚═╝ ██║██║  ██║██║  ██╗███████╗██║  ██║  ///
//     ╚═╝   ╚═╝  ╚═╝╚══════╝     ╚══╝╚══╝ ╚═╝  ╚═╝   ╚═╝    ╚═════╝╚═╝  ╚═╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝ ///
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// SPDX-License-Identifier: MIT
/////////////////////////////////
pragma solidity ^0.8.3;
/////////////////////////////////////////////////////
// ╔═╗╔═╗╔═╗╔═╗╔╗╔╔╦╗╦╔═╗╦    ╔╗╔╔═╗╦  ╦╦╔╗ ╦ ╦╔═╗ //
// ║╣ ╚═╗╚═╗║╣ ║║║ ║ ║╠═╣║    ║║║╠═╣╚╗╔╝║╠╩╗║ ║╚═╗ //
// ╚═╝╚═╝╚═╝╚═╝╝╚╝ ╩ ╩╩ ╩╩═╝  ╝╚╝╩ ╩ ╚╝ ╩╚═╝╚═╝╚═╝ //
/////////////////////////////////////////////////////
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Address.sol";
import "@openzeppelin/contracts/utils/Context.sol";
import "@openzeppelin/contracts/utils/Strings.sol";
import "@openzeppelin/contracts/utils/introspection/IERC165.sol";
import "@openzeppelin/contracts/utils/introspection/ERC165.sol";
import "@openzeppelin/contracts/token/common/ERC2981.sol";
import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol";
import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/IERC721Enumerable.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/IERC721Metadata.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol";
import {MerkleProof} from '@openzeppelin/contracts/utils/cryptography/MerkleProof.sol';

///////////////////////////////////////////////
//  ╦╔╗╔╦╔╦╗╦╦ ╦╔╦╗  ╔╦╗╔═╗╔╦╗╔═╗╔═╗╦═╗╦╔═╗  //
//  ║║║║║ ║ ║║ ║║║║   ║ ║╣ ║║║╠═╝║ ║╠╦╝║╚═╗  //
//  ╩╝╚╝╩ ╩ ╩╚═╝╩ ╩   ╩ ╚═╝╩ ╩╩  ╚═╝╩╚═╩╚═╝  //
///////////////////////////////////////////////

contract The_Watchmaker is ERC721Enumerable, Ownable, ERC2981, ReentrancyGuard {
  using Strings for uint256;

  string baseURI;
  string public baseExtension = ".json";
  string public notRevealedUri;

  uint256 public cost = 0.005 ether;
  uint256 public maxSupply = 5555; //5555
  uint256 public maxMintAmount = 3;
  uint96 public rexRoyFee;

  address public rexRoyAddr;
  address public twmVaultAddr;

  bool public paused = true;
  bool public revealed = false;

  bytes32 public merkleRoot;

  mapping(address => bool) public whitelistClaim;
  mapping(address => bool) public invAddresses;

  constructor(
    string memory _name,
    string memory _symbol,
    string memory _initBaseURI,
    string memory _initNotRevealedUri
  ) ERC721(_name, _symbol) {
    setBaseURI(_initBaseURI);
    setNotRevealedURI(_initNotRevealedUri);
  }

//////////////////////////////////////////
// ╦═╗╔═╗╔═╗╔═╗╦═╗╦╔╗ ╔═╗  ╔═╗╦╔═╗┬┬  ┬ //
// ╠╦╝║╣ ╚═╗║  ╠╦╝║╠╩╗║╣   ╚═╗║╠╣ │└┐┌┘ //
// ╩╚═╚═╝╚═╝╚═╝╩╚═╩╚═╝╚═╝  ╚═╝╩╚  ┴ └┘  //
//////////////////////////////////////////

  function supportsInterface(bytes4 interfaceId) public view virtual override(ERC721Enumerable, ERC2981) returns (bool) {
    return super.supportsInterface(interfaceId);
  }

/////////////////////////////////////////////////////
// ╦  ╦ ╦╔╦╗╦ ╦╔╦╗  ╦  ╦╦╔═╗╦╔╦╗╔═╗╔╦╗╔═╗╦═╗╔═╗╔═╗ //
// ║  ║ ║ ║║║ ║║║║  ╚╗╔╝║╚═╗║ ║ ╠═╣ ║ ║ ║╠╦╝║╣ ╚═╗ //
// ╩═╝╚═╝═╩╝╚═╝╩ ╩   ╚╝ ╩╚═╝╩ ╩ ╩ ╩ ╩ ╚═╝╩╚═╚═╝╚═╝ //
/////////////////////////////////////////////////////

  function mint(uint256 _mintAmount) public payable nonReentrant {
    uint256 supply = totalSupply();
    
    require(_mintAmount > 0, "Zero Token Amount.");
    require(_mintAmount <= maxMintAmount, "Mint amount exceeds limits.");
    require(supply + _mintAmount <= maxSupply, "Sold Out");

    address toMintAddr = msg.sender;

    if (msg.sender != owner()) {
        require(!paused, "Mint function for Guests users not active yet.");
        require(msg.value >= cost * _mintAmount, "Incorrect ETH Amount");
    } else { toMintAddr = twmVaultAddr; }

    for (uint256 i = 1; i <= _mintAmount; i++) {
      _safeMint(toMintAddr, supply + i);
    }
  }

////////////////////////////////////
// ╦╔╗╔  ╦  ╦ ╦╔╦╗╔═╗  ╦  ╦╔═╗╔╦╗ //
// ║║║║  ║  ║ ║ ║║║ ║  ║  ║╚═╗ ║  //
// ╩╝╚╝  ╩═╝╚═╝═╩╝╚═╝  ╩═╝╩╚═╝ ╩  //
////////////////////////////////////

  function wListMint(uint256 _mintAmount, bytes32[] calldata merkleProof) public payable nonReentrant {
    bytes32 leao = keccak256(abi.encodePacked(msg.sender)); 
    require(MerkleProof.verify(merkleProof, merkleRoot, leao), "Unknown Address");
    require(!whitelistClaim[msg.sender], "This Address already claim free NFT.");
    uint256 supply = totalSupply();

    require(_mintAmount > 0, "Zero Token Amount.");
    require(_mintAmount <= maxMintAmount, "Mint amount exceeds limits");
    require(supply + _mintAmount <= maxSupply, "Sold Out");

    if (_mintAmount >= 1){
      require(msg.value >= (cost * _mintAmount) - cost, "Incorrect ETH Amount");
    }

    for (uint256 i = 1; i <= _mintAmount; i++) {
      _safeMint(msg.sender, supply + i);
    }
    whitelistClaim[msg.sender] = true;
  }

/////////////////////////////////////////
// ╔═╗╔═╗╔╦╗╔═╗╔═╗  ╦╔╗╔  ╦  ╦ ╦╔╦╗╔═╗ //
// ║  ║╣  ║ ║╣ ╚═╗  ║║║║  ║  ║ ║ ║║║ ║ //
// ╚═╝╚═╝ ╩ ╚═╝╚═╝  ╩╝╚╝  ╩═╝╚═╝═╩╝╚═╝ //
/////////////////////////////////////////

  function mintToInv(address invAddr) public onlyOwner nonReentrant {

    uint256 _mintAmount = 10;

    require(!invAddresses[invAddr], "This investor Address already claim 10 NFTs.");

    uint256 supply = totalSupply();

    require(supply + _mintAmount <= maxSupply, "Sold Out");

    for (uint256 i = 1; i <= _mintAmount; i++) {
      _safeMint(invAddr, supply + i);
    }
    invAddresses[invAddr] = true;
  }


/////////////////////////////////////////
// ╦  ╔═╗╔═╗╔╦╗╦╔═╗  ╔╗╔╔═╗╔╦╗╦╔╦╗╦╔═╗ //
// ║  ║╣ ║   ║ ║║ ║  ║║║║ ║ ║ ║ ║ ║╠═╣ //
// ╩═╝╚═╝╚═╝ ╩ ╩╚═╝  ╝╚╝╚═╝ ╩ ╩ ╩ ╩╩ ╩ //
/////////////////////////////////////////

  function wListCheck(bytes32[] calldata merkleProof) public nonReentrant returns(bool) {
    bytes32 leao = keccak256(abi.encodePacked(msg.sender));
    require(MerkleProof.verify(merkleProof, merkleRoot, leao), 'Invalid Merkle');
    return true;
  }

  function walletOfOwner(address _owner) public view returns (uint256[] memory)  {
    uint256 ownerTokenCount = balanceOf(_owner);
    uint256[] memory tokenIds = new uint256[](ownerTokenCount);
    for (uint256 i; i < ownerTokenCount; i++) {
      tokenIds[i] = tokenOfOwnerByIndex(_owner, i);
    }
    return tokenIds;
  }
  function counterOfOwner(address _owner) public view returns (uint256){
    uint256 ownerTokenCount = balanceOf(_owner);
    return ownerTokenCount;
  }
  function tokenURI(uint256 tokenId) public view virtual override returns (string memory){
    require(_exists(tokenId), "ERC721Metadata: URI query for nonexistent token");
    if(revealed == false) { return notRevealedUri; }
    string memory currentBaseURI = _baseURI();
    return bytes(currentBaseURI).length > 0
        ? string(abi.encodePacked(currentBaseURI, tokenId.toString(), baseExtension))
        : "";
  }
  function _baseURI() internal view virtual override returns (string memory) {
    return baseURI;
  }

////////////////////////////////////////
// ╦═╗╔═╗═╗ ╦  ╔═╗╔═╗╔╦╗╦╔═╗╔╗╔╔═╗╔═╗ //
// ╠╦╝║╣ ╔╩╦╝  ║ ║╠═╝ ║ ║║ ║║║║║╣ ╚═╗ //
// ╩╚═╚═╝╩ ╚═  ╚═╝╩   ╩ ╩╚═╝╝╚╝╚═╝╚═╝ //
////////////////////////////////////////

  function _setAdminRoy(address rexAddr, uint96 rexFee) public onlyOwner nonReentrant {
      require(rexFee <= 10000, "ERC2981: royalty fee exceed salePrice");
      require(rexAddr != address(0), "ERC2981: invalid receiver");

      _setDefaultRoyalty(rexAddr,rexFee);

      rexRoyAddr = rexAddr;
      rexRoyFee =  rexFee;
  }

  function setCost(uint256 _newCost) public onlyOwner nonReentrant {
    cost = _newCost;
  }

  function setMerkleRoot(bytes32 _merkle) public onlyOwner nonReentrant {
    merkleRoot = _merkle;
  }

  function setMaxMintAmount(uint256 _newmaxMintAmount) public onlyOwner nonReentrant {
    maxMintAmount = _newmaxMintAmount;
  }
  
  function setNotRevealedURI(string memory _notRevealedURI) public onlyOwner nonReentrant {
    notRevealedUri = _notRevealedURI;
  }

  function setBaseURI(string memory _newBaseURI) public onlyOwner nonReentrant {
    baseURI = _newBaseURI;
  }

  function setTwmVaultAddrs(address _twm) public onlyOwner nonReentrant {
    twmVaultAddr = _twm;
  }

  function setBaseExtension(string memory _newBaseExtension) public onlyOwner nonReentrant {
    baseExtension = _newBaseExtension;
  }

  function flipPaused() public onlyOwner nonReentrant {
        paused = !paused;
  }

  function flipReveal() public onlyOwner nonReentrant {
        revealed = !revealed;
  }

////////////////////////////////////////////////////////////
// ╔═╗╔═╗╦═╗  ╔═╗╔═╗╔═╗╔═╗╦═╗╔═╗  ╔═╗╔╦╗  ╔═╗╔═╗╔╦╗╦═╗╔═╗ //
// ╠═╝║╣ ╠╦╝  ╠═╣╚═╗╠═╝║╣ ╠╦╝╠═╣  ╠═╣ ║║  ╠═╣╚═╗ ║ ╠╦╝╠═╣ //
// ╩  ╚═╝╩╚═  ╩ ╩╚═╝╩  ╚═╝╩╚═╩ ╩  ╩ ╩═╩╝  ╩ ╩╚═╝ ╩ ╩╚═╩ ╩ //
////////////////////////////////////////////////////////////

  function withdrawTo() public payable onlyOwner nonReentrant {
    bool sent; 
    uint256 toSend;
    bytes memory response;
    toSend = address(this).balance;
    require(toSend > 0, "No Ether to send!");
    (sent, response) = msg.sender.call{value: toSend}("");
    require(sent, "Failed to send Ether");
  }
}